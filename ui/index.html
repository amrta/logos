<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>LOGOS</title>
<style>
:root{
  --bg:#0c0c0c;--bg2:#151515;--bg3:#1c1c1c;--bd:#252525;--tx:#aaa;--tx2:#555;
  --ac:#00d4aa;--e0:#f59e0b;--e1:#06b6d4;--e2:#6b7280;
  --ok:#22c55e;--err:#ef4444;--warn:#eab308;
  --terminal-bg:#080808;
}
.light{
  --bg:#f0ebe0;--bg2:#e8e0d0;--bg3:#ddd5c4;--bd:#c0b89a;--tx:#2a1f15;--tx2:#7a6e5b;
  --ac:#0e7a64;--e0:#b45309;--e1:#0e7490;--e2:#6b7280;
  --ok:#15803d;--err:#b91c1c;--warn:#a16207;--terminal-bg:#e5dcc5;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:13px;line-height:1.45;background:var(--bg);color:var(--tx);
  height:100vh;display:grid;grid-template-rows:34px 1fr 26px;overflow:hidden;
  -webkit-font-smoothing:antialiased}
button{background:none;border:none;color:inherit;font:inherit;cursor:pointer}
input,textarea{font:inherit;background:transparent;color:var(--tx);outline:none;border:none}
textarea{resize:none;overflow:hidden}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}

header{display:flex;align-items:center;padding:0 14px;gap:8px;
  background:var(--bg2);border-bottom:1px solid var(--bd);z-index:10}
header .logo{color:var(--ac);letter-spacing:0.2em;font-size:15px;font-weight:800}
header .sep{width:1px;height:16px;background:var(--bd)}
.hstat{font-size:12px;opacity:0.45;font-weight:600}.hstat b{opacity:1;color:var(--ac)}
.hbtn{width:26px;height:26px;display:flex;align-items:center;justify-content:center;
  border-radius:3px;opacity:0.35;font-size:15px}
.hbtn:hover{opacity:1;background:var(--bd)}

footer{display:flex;align-items:center;padding:0 14px;gap:12px;
  background:var(--bg2);border-top:1px solid var(--bd);font-size:11px;font-weight:600;opacity:0.35}

#app{display:flex;overflow:hidden;min-height:0}

#left-panel{width:220px;border-right:1px solid var(--bd);background:var(--bg2);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
#center{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;position:relative}
#right-panel{width:340px;border-left:1px solid var(--bd);background:var(--bg2);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}

.panel-head{font-size:11px;font-weight:700;letter-spacing:0.08em;
  padding:8px 12px;opacity:0.3;border-bottom:1px solid var(--bd);flex-shrink:0}
.panel-body{flex:1;overflow-y:auto;padding:10px 12px;min-height:0}

.tab-bar{display:flex;border-bottom:1px solid var(--bd);flex-shrink:0}
.tab{padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer;
  border-bottom:2px solid transparent;opacity:0.45;transition:all 0.15s}
.tab:hover{opacity:0.8}
.tab.active{opacity:1;border-bottom-color:var(--ac)}
.tab-content{display:none;flex:1;overflow-y:auto;min-height:0}
.tab-content.active{display:flex;flex-direction:column}

#neural-canvas{flex:1;min-height:0;cursor:grab}
#neural-canvas:active{cursor:grabbing}

.left-section{padding:10px 12px;border-bottom:1px solid var(--bd)}
.left-section:last-child{border-bottom:none}
.left-label{font-size:10px;font-weight:700;opacity:0.3;margin-bottom:6px;letter-spacing:0.06em}
.metric-row{display:flex;justify-content:space-between;align-items:center;padding:2px 0;font-size:12px}
.metric-row .val{font-weight:700;color:var(--ac)}
.bar-track{height:4px;background:var(--bg);border-radius:2px;margin-top:3px;overflow:hidden}
.bar-fill{height:100%;background:var(--ac);border-radius:2px;transition:width 0.5s}

.evo-bar-row{display:flex;align-items:center;gap:6px;padding:2px 0}
.evo-label{width:90px;font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.evo-track{flex:1;height:5px;background:var(--bg);border-radius:3px;overflow:hidden}
.evo-fill{height:100%;border-radius:3px;transition:width 0.6s}
.evo-fill-n{background:linear-gradient(90deg,var(--e1),var(--ac))}
.evo-fill-p{background:linear-gradient(90deg,var(--ok),var(--warn))}
.evo-val{font-size:11px;font-weight:700;width:36px;text-align:right}
.evo-star{color:var(--warn)}

.chip{display:inline-block;font-size:11px;padding:2px 8px;background:var(--bg3);
  border:1px solid var(--bd);border-radius:3px;margin:2px;font-weight:600}
.chip b{color:var(--ac)}
.atom-badge{display:inline-block;font-size:10px;padding:2px 6px;background:var(--bg3);
  border:1px solid var(--bd);border-radius:3px;margin:1px 2px;font-weight:600}

.ev-line{font-size:11px;line-height:1.6;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  opacity:0.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ev-line:first-child{opacity:0.9}
.ev-exec{color:var(--ok)}.ev-route{color:var(--e1)}.ev-cache{color:var(--warn)}
.ev-absorb{color:#a78bfa}.ev-self{color:var(--ac)}.ev-evolve{color:var(--e0)}.ev-auto{color:#e879f9}

.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
.stat-cell{background:var(--bg3);border:1px solid var(--bd);border-radius:3px;padding:6px 8px;text-align:center}
.stat-val{font-size:16px;font-weight:800;color:var(--ac);line-height:1.2}
.stat-lbl{font-size:10px;opacity:0.35;margin-top:1px}

#term-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
#term{flex:1;padding:10px 12px;overflow-y:auto;font-size:13px;line-height:1.6;color:var(--ac);
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--terminal-bg)}
#term-bar{padding:8px 12px;background:var(--bg2);border-top:1px solid var(--bd);flex-shrink:0}
.mode-btns{display:flex;gap:4px;margin-bottom:6px}
.mode-btn{font-size:11px;font-weight:700;padding:3px 10px;border:1px solid var(--bd);border-radius:3px}
.mode-btn.active{border-color:var(--ac);color:var(--ac);background:rgba(0,212,170,0.1)}
.mode-btn:not(.active){opacity:0.35}
#term-input-row{display:flex;align-items:center;gap:6px}
#term-prompt{font-weight:800;color:var(--ac);font-size:14px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
#term-input{flex:1;font-size:13px;padding:3px 0;line-height:1.4;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.fb-row{display:flex;gap:8px;margin:3px 0 6px}
.fb-btn{font-size:10px;opacity:0.25;transition:opacity 0.2s}
.fb-btn:hover{opacity:0.9}

#settings-overlay{display:none;position:fixed;top:34px;right:10px;z-index:100;
  background:var(--bg2);border:1px solid var(--bd);border-radius:6px;padding:12px;width:300px;
  box-shadow:0 12px 40px rgba(0,0,0,0.6)}
#settings-overlay input{width:100%;padding:5px 8px;background:var(--bg);border:1px solid var(--bd);
  border-radius:3px;margin:4px 0 8px;font-size:12px}
#settings-overlay .s-label{font-size:11px;font-weight:700;opacity:0.5}

.cfg-row{display:flex;justify-content:space-between;font-size:11px;padding:2px 0;opacity:0.45}
.cfg-row b{opacity:1;color:var(--ac)}

@keyframes synapse-pulse{
  0%{opacity:0.05}50%{opacity:0.35}100%{opacity:0.05}
}
</style>
</head>
<body>

<header>
  <span class="logo">LOGOS</span>
  <span class="sep"></span>
  <span class="hstat" id="h-ver">v?</span>
  <span class="sep"></span>
  <span class="hstat">&#8593; <b id="h-up">00:00:00</b></span>
  <span class="sep"></span>
  <span class="hstat"><b id="h-pouches">-</b> 尿袋</span>
  <span class="hstat"><b id="h-atoms">-</b> 原子</span>
  <span class="hstat"><b id="h-mem-count">-</b> 模式</span>
  <span class="sep"></span>
  <span id="h-dot" style="width:7px;height:7px;border-radius:50%;background:var(--ok);box-shadow:0 0 6px var(--ok)"></span>
  <span style="flex:1"></span>
  <button class="hbtn" onclick="toggleTheme()" title="切换主题">&#9680;</button>
  <button class="hbtn" onclick="toggleSettings()" title="设置">&#9881;</button>
</header>

<div id="settings-overlay">
  <div class="s-label">Worker 地址</div>
  <input id="s-worker" placeholder="https://logos-gateway..."/>
  <div class="s-label">后端地址</div>
  <input id="s-backend" placeholder="http://127.0.0.1:3000"/>
  <div style="display:flex;gap:6px;margin-top:6px">
    <button onclick="saveSettings()" style="padding:4px 14px;background:var(--ac);color:#000;border-radius:3px;font-weight:700;font-size:11px">保存</button>
    <button onclick="toggleSettings()" style="padding:4px 14px;border:1px solid var(--bd);border-radius:3px;font-size:11px">取消</button>
  </div>
</div>

<div id="app">
  <aside id="left-panel">
    <div class="panel-head">环境监测</div>
    <div class="panel-body" style="padding:0">
      <div class="left-section">
        <div class="left-label">系统资源</div>
        <div class="metric-row"><span>内核负载</span><span class="val" id="lp-cpu">0%</span></div>
        <div class="bar-track"><div class="bar-fill" id="lp-cpu-bar" style="width:0%"></div></div>
        <div class="metric-row" style="margin-top:6px"><span>内存</span><span class="val" id="lp-mem">0 MB</span></div>
        <div class="metric-row"><span>温度</span><span class="val" id="lp-temp">0°C</span></div>
      </div>
      <div class="left-section">
        <div class="left-label">尿袋群</div>
        <div id="lp-pouches-list"></div>
      </div>
      <div class="left-section">
        <div class="left-label">原子能力</div>
        <div id="lp-atoms"></div>
      </div>
      <div class="left-section">
        <div class="left-label">自主学习</div>
        <div class="metric-row"><span>阶段</span><span class="val" id="lp-learn-phase">idle</span></div>
        <div class="metric-row"><span>周期</span><span class="val" id="lp-learn-cycle">0</span></div>
        <div class="metric-row"><span>饱和度</span><span class="val" id="lp-learn-sat">0%</span></div>
        <div class="bar-track"><div class="bar-fill" id="lp-learn-sat-bar" style="width:0%"></div></div>
        <div class="metric-row" style="margin-top:4px"><span>外部投喂</span><span class="val" id="lp-learn-ext">0/0</span></div>
        <div class="metric-row"><span>突触互学</span><span class="val" id="lp-learn-syn">0/0</span></div>
      </div>
    </div>
  </aside>

  <main id="center">
    <div class="tab-bar">
      <div class="tab active" data-target="view-neural">神经视图</div>
      <div class="tab" data-target="view-evo">演化引擎</div>
      <div class="tab" data-target="view-events">事件流</div>
      <div class="tab" data-target="view-stats">系统状态</div>
    </div>
    <div id="view-neural" class="tab-content active" style="background:var(--bg)">
      <div id="neural-wrap" style="flex:1;min-height:0;position:relative;overflow:hidden">
        <svg id="neural-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
    </div>
    <div id="view-evo" class="tab-content" style="padding:12px 16px"></div>
    <div id="view-events" class="tab-content" style="padding:10px 14px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></div>
    <div id="view-stats" class="tab-content" style="padding:12px 16px"></div>
  </main>

  <aside id="right-panel">
    <div class="tab-bar">
      <div class="tab active" data-target="rp-dialogue">对话</div>
      <div class="tab" data-target="rp-diag">诊断</div>
    </div>
    <div id="rp-dialogue" class="tab-content active">
      <div id="term-wrap">
        <div id="term"></div>
        <div id="term-bar">
          <div class="mode-btns">
            <button class="mode-btn active" id="btn-cmd" onclick="setMode('command')">$ 命令</button>
            <button class="mode-btn" id="btn-nat" onclick="setMode('natural')">&#187; 对话</button>
            <button class="mode-btn" id="btn-lang" onclick="setMode('language')">L&gt; 语言</button>
          </div>
          <div id="term-input-row">
            <span id="term-prompt">$</span>
            <textarea id="term-input" rows="1" placeholder="输入命令，回车发送"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div id="rp-diag" class="tab-content" style="padding:10px 12px">
      <div id="diag-body"></div>
    </div>
  </aside>
</div>

<footer>
  <span id="ft-ver">Logos Kernel v5.0.0</span>
  <span style="flex:1"></span>
  <span id="ft-summary">-</span>
</footer>

<script>
var WORKER = localStorage.getItem('logos_worker') || 'https://logos-gateway.amrta.workers.dev';
function getBackend() {
    var s = (localStorage.getItem('logos_backend') || '').replace(/\/$/,'');
    if (s) return s;
    var l = window.location;
    if ((l.protocol === 'http:' || l.protocol === 'https:') && l.hostname !== '') return l.origin;
    return '';
}

var D = null, upSec = 0, mode = 'command';

setInterval(function() {
    upSec++;
    var h = String(Math.floor(upSec/3600)).padStart(2,'0');
    var m = String(Math.floor((upSec%3600)/60)).padStart(2,'0');
    var s = String(upSec%60).padStart(2,'0');
    setText('h-up', h+':'+m+':'+s);
}, 1000);

(function initTabs() {
    document.querySelectorAll('.tab-bar').forEach(function(bar) {
        bar.querySelectorAll('.tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                bar.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
                tab.classList.add('active');
                var parent = bar.parentElement;
                parent.querySelectorAll('.tab-content').forEach(function(c){ c.classList.remove('active'); });
                var target = parent.querySelector('#' + tab.dataset.target);
                if (target) target.classList.add('active');
                if (tab.dataset.target === 'view-neural') requestAnimationFrame(renderNeural);
            });
        });
    });
})();

function fetchDashboard() {
    var backend = getBackend();
    if (!backend) return;
    fetch(backend + '/api/dashboard').then(function(r){return r.json()}).then(function(d) {
        D = d;
        renderAll(d);
    }).catch(function(){});
}
fetchDashboard();
setInterval(fetchDashboard, 2500);

function renderAll(d) {
    setText('h-ver', 'v' + d.v);
    setText('h-pouches', (d.pouches||[]).length);
    setText('h-atoms', d.atoms ? d.atoms.total : 0);
    setText('h-mem-count', d.memory || 0);
    var dot = document.getElementById('h-dot');
    if (dot) {
        dot.style.background = d.ready ? 'var(--ok)' : 'var(--err)';
        dot.style.boxShadow = '0 0 6px ' + (d.ready ? 'var(--ok)' : 'var(--err)');
    }
    setText('ft-ver', 'Logos Kernel v' + d.v);
    setText('ft-summary', (d.pouches||[]).length + ' 尿袋 · ' + (d.atoms?d.atoms.total:0) + ' 原子 · ' + (d.memory||0) + ' 模式 · ' + (d.evo?d.evo.total:0) + ' 演化记录');
    renderLeft(d);
    renderNeural();
    renderEvo(d);
    renderEvents(d);
    renderStats(d);
    renderDiag(d);
}

function renderLeft(d) {
    setText('lp-cpu', (d.cpu||0).toFixed(1) + '%');
    setText('lp-mem', (d.mem||0) + ' MB');
    setText('lp-temp', (d.temp||0).toFixed(0) + '°C');
    var cpuBar = document.getElementById('lp-cpu-bar');
    if (cpuBar) cpuBar.style.width = Math.min(100, d.cpu||0) + '%';

    var activeSet = {};
    (d.events||[]).slice(-20).forEach(function(e){
        var m = e.match(/(?:EXEC|ROUTE.*\u2192)\s*(\S+)/);
        if (m) activeSet[m[1]] = true;
    });
    var plist = document.getElementById('lp-pouches-list');
    if (plist) {
        var ps = d.pouches || [];
        var byRole = {E0:[], E1:[], E2:[]};
        ps.forEach(function(p){ (byRole[p.role]||byRole.E1).push(p); });
        var html = '';
        ['E0','E1','E2'].forEach(function(role) {
            var arr = byRole[role];
            if (!arr.length) return;
            var roleColor = role==='E0'?'var(--e0)':role==='E2'?'var(--e2)':'var(--e1)';
            var grpId = 'pg-'+role;
            html += '<div style="padding:3px 0;cursor:pointer" onclick="var b=document.getElementById(\''+grpId+'\');b.style.display=b.style.display===\'none\'?\'block\':\'none\'">';
            html += '<span style="color:'+roleColor+';font-size:10px;font-weight:800">'+role+'</span>';
            html += '<span style="font-size:10px;opacity:0.35;margin-left:4px">'+arr.length+'</span>';
            html += '<span style="font-size:9px;opacity:0.2;float:right">\u25be</span>';
            html += '</div>';
            html += '<div id="'+grpId+'" style="'+(arr.length>20?'max-height:180px;overflow-y:auto;':'')+'">';
            arr.forEach(function(p) {
                var hot = activeSet[p.name];
                var dotStyle = p.awake
                    ? 'background:var(--ok);box-shadow:0 0 '+(hot?'6':'2')+'px var(--ok)'
                    : 'background:var(--tx2);opacity:0.3';
                html += '<div style="display:flex;align-items:center;gap:5px;padding:1px 0 1px 8px;font-size:11px'+(hot?';opacity:1':';opacity:0.7')+'">';
                html += '<span style="width:5px;height:5px;border-radius:50%;flex-shrink:0;'+dotStyle+'"></span>';
                html += '<span style="font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+p.name+'</span>';
                if (p.memory > 0) html += '<span style="font-size:9px;opacity:0.35">'+p.memory+'</span>';
                html += '</div>';
            });
            html += '</div>';
        });
        plist.innerHTML = html;
    }

    var atomsEl = document.getElementById('lp-atoms');
    if (atomsEl && d.atoms) {
        var kinds = d.atoms.kinds || {};
        var kindNames = {Match:'\u5339\u914d',Transform:'\u53d8\u6362',Score:'\u8bc4\u5206',Generate:'\u751f\u6210',Validate:'\u9a8c\u8bc1',Route:'\u8def\u7531'};
        var html = '';
        ['Match','Transform','Score','Generate','Validate','Route'].forEach(function(k) {
            if (kinds[k]) html += '<span class="atom-badge">'+(kindNames[k]||k)+' '+kinds[k]+'</span>';
        });
        atomsEl.innerHTML = html || '<span style="opacity:0.2">\u2014</span>';
    }

    if (d.learn) {
        var L = d.learn;
        var phaseMap = {idle:'\u5f85\u547d',external:'\u5916\u90e8\u5438\u6536',miss_driven:'\u7f3a\u5931\u9a71\u52a8',synapse:'\u7a81\u89e6\u4e92\u5b66'};
        setText('lp-learn-phase', phaseMap[L.phase] || L.phase);
        setText('lp-learn-cycle', L.cycle || 0);
        var satPct = Math.round((L.saturation || 0) * 100);
        setText('lp-learn-sat', satPct + '%');
        var satBar = document.getElementById('lp-learn-sat-bar');
        if (satBar) {
            satBar.style.width = satPct + '%';
            satBar.style.background = satPct > 60 ? 'var(--warn)' : 'var(--ac)';
        }
        setText('lp-learn-ext', (L.ext_absorbed||0) + '/' + (L.ext_fed||0));
        setText('lp-learn-syn', (L.syn_absorbed||0) + '/' + (L.syn_fed||0));
    }
}

function lerpColor(a, b, t) {
    var ah = parseInt(a.slice(1), 16), bh = parseInt(b.slice(1), 16);
    var ar = (ah >> 16) & 0xff, ag = (ah >> 8) & 0xff, ab = ah & 0xff;
    var br = (bh >> 16) & 0xff, bg2 = (bh >> 8) & 0xff, bb = bh & 0xff;
    var rr = Math.round(ar + (br - ar) * t);
    var rg = Math.round(ag + (bg2 - ag) * t);
    var rb = Math.round(ab + (bb - ab) * t);
    return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb).toString(16).slice(1);
}

function maturityColor(t, C) {
    if (t <= 0) return C.newborn;
    if (t >= 1) return C.mature;
    if (t < 0.5) return lerpColor(C.newborn, C.growing, t * 2);
    return lerpColor(C.growing, C.mature, (t - 0.5) * 2);
}

function pouchMaturity(p, evoMap, threshold) {
    var evo = evoMap[p.name];
    var evoPart = evo ? Math.min(1, evo.v / threshold) : 0;
    var memPart = Math.min(1, p.memory / 200);
    var promBonus = (evo && evo.p) ? 0.3 : 0;
    return Math.min(1, evoPart * 0.55 + memPart * 0.35 + promBonus + (p.role === 'E0' ? 0.1 : 0));
}

function renderNeural() {
    if (!D) return;
    var wrap = document.getElementById('neural-wrap');
    var svg = document.getElementById('neural-canvas');
    if (!wrap || !svg) return;
    var W = wrap.clientWidth, H = wrap.clientHeight;
    if (W < 10 || H < 10) return;
    svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);

    var isLight = document.body.classList.contains('light');
    var C = isLight
        ? {bg:'#f0ebe0',bg3:'#ddd5c4',tx:'#2a1f15',ac:'#0e7a64',
           newborn:'#9ca3af',growing:'#0e7490',mature:'#b45309',
           ok:'#15803d',warn:'#a16207',orbitE0:'#b45309',orbitE1:'#0e7490',orbitE2:'#9ca3af'}
        : {bg:'#0c0c0c',bg3:'#1c1c1c',tx:'#aaa',ac:'#00d4aa',
           newborn:'#334155',growing:'#06b6d4',mature:'#f59e0b',
           ok:'#22c55e',warn:'#eab308',orbitE0:'#f59e0b',orbitE1:'#06b6d4',orbitE2:'#6b7280'};

    var cx = W / 2, cy = H / 2;
    var ps = D.pouches || [];
    var evoMap = {};
    var threshold = (D.evo && D.evo.threshold) || 100;
    if (D.evo && D.evo.records) {
        D.evo.records.forEach(function(r){ if (!evoMap[r.pouch] || r.v > evoMap[r.pouch].v) evoMap[r.pouch] = r; });
    }
    var activeSet = {};
    (D.events||[]).slice(-20).forEach(function(e){
        var m = e.match(/(?:EXEC|ROUTE.*\u2192)\s*(\S+)/);
        if (m) activeSet[m[1]] = true;
    });

    var groups = {E0:[], E1:[], E2:[]};
    ps.forEach(function(p){ (groups[p.role] || groups.E1).push(p); });

    var totalNodes = ps.length;
    var dim = Math.min(W, H);
    var maxPerRing = Math.max(8, Math.floor(dim * 0.22));
    var orbits = [];
    if (groups.E0.length) orbits.push({r: dim * 0.08, ps: groups.E0, clr: C.orbitE0});
    if (groups.E1.length) {
        var e1 = groups.E1;
        if (e1.length <= maxPerRing) {
            orbits.push({r: dim * 0.28, ps: e1, clr: C.orbitE1});
        } else if (e1.length <= maxPerRing * 2) {
            var half = Math.ceil(e1.length / 2);
            orbits.push({r: dim * 0.22, ps: e1.slice(0, half), clr: C.orbitE1});
            orbits.push({r: dim * 0.36, ps: e1.slice(half), clr: C.orbitE1});
        } else {
            var third = Math.ceil(e1.length / 3);
            orbits.push({r: dim * 0.18, ps: e1.slice(0, third), clr: C.orbitE1});
            orbits.push({r: dim * 0.30, ps: e1.slice(third, third*2), clr: C.orbitE1});
            orbits.push({r: dim * 0.42, ps: e1.slice(third*2), clr: C.orbitE1});
        }
    }
    if (groups.E2.length) orbits.push({r: dim * 0.46, ps: groups.E2, clr: C.orbitE2});

    var nodeR = totalNodes > 30 ? dim * 0.025 : totalNodes > 16 ? dim * 0.032 : dim * 0.04;
    var ns = 'http://www.w3.org/2000/svg';
    var frag = document.createDocumentFragment();

    var bgRect = document.createElementNS(ns, 'rect');
    bgRect.setAttribute('width', W); bgRect.setAttribute('height', H);
    bgRect.setAttribute('fill', C.bg);
    frag.appendChild(bgRect);

    var defs = document.createElementNS(ns, 'defs');
    var glow = document.createElementNS(ns, 'filter');
    glow.id = 'glow';
    glow.setAttribute('x','-50%'); glow.setAttribute('y','-50%');
    glow.setAttribute('width','200%'); glow.setAttribute('height','200%');
    var gb = document.createElementNS(ns, 'feGaussianBlur');
    gb.setAttribute('stdDeviation','5'); gb.setAttribute('result','b');
    glow.appendChild(gb);
    var fm = document.createElementNS(ns, 'feMerge');
    var f1 = document.createElementNS(ns, 'feMergeNode'); f1.setAttribute('in','b'); fm.appendChild(f1);
    var f2 = document.createElementNS(ns, 'feMergeNode'); f2.setAttribute('in','SourceGraphic'); fm.appendChild(f2);
    glow.appendChild(fm);
    defs.appendChild(glow);
    frag.appendChild(defs);

    orbits.forEach(function(orb) {
        var ring = document.createElementNS(ns, 'circle');
        ring.setAttribute('cx', cx); ring.setAttribute('cy', cy); ring.setAttribute('r', orb.r);
        ring.setAttribute('fill', 'none'); ring.setAttribute('stroke', orb.clr);
        ring.setAttribute('stroke-width', '0.6'); ring.setAttribute('stroke-dasharray', '3,8');
        ring.setAttribute('opacity', '0.12');
        frag.appendChild(ring);
    });

    var coreR = Math.min(W, H) * 0.06;
    var coreC = document.createElementNS(ns, 'circle');
    coreC.setAttribute('cx', cx); coreC.setAttribute('cy', cy); coreC.setAttribute('r', coreR);
    coreC.setAttribute('fill', C.bg3); coreC.setAttribute('stroke', C.ac); coreC.setAttribute('stroke-width', '2');
    coreC.setAttribute('filter', 'url(#glow)');
    frag.appendChild(coreC);
    var cTxt = document.createElementNS(ns, 'text');
    cTxt.setAttribute('x', cx); cTxt.setAttribute('y', cy + 1);
    cTxt.setAttribute('text-anchor', 'middle'); cTxt.setAttribute('dominant-baseline', 'central');
    cTxt.setAttribute('fill', C.ac); cTxt.setAttribute('font-size', Math.max(11, coreR * 0.5));
    cTxt.setAttribute('font-weight', '800'); cTxt.setAttribute('letter-spacing', '0.12em');
    cTxt.textContent = 'LOGOS';
    frag.appendChild(cTxt);

    var nodes = [];
    orbits.forEach(function(orb) {
        var n = orb.ps.length;
        orb.ps.forEach(function(p, i) {
            var a = -Math.PI/2 + (i/n) * Math.PI * 2;
            nodes.push({name:p.name, x:cx+orb.r*Math.cos(a), y:cy+orb.r*Math.sin(a), p:p, orb:orb,
                mat: pouchMaturity(p, evoMap, threshold)});
        });
    });

    nodes.forEach(function(nd) {
        var hot = activeSet[nd.name];
        var evo = evoMap[nd.name];
        var clr = maturityColor(nd.mat, C);
        var strength = nd.mat * 0.35 + 0.02;
        if (hot) strength = Math.max(strength, 0.35);
        var line = document.createElementNS(ns, 'line');
        line.setAttribute('x1', cx); line.setAttribute('y1', cy);
        line.setAttribute('x2', nd.x); line.setAttribute('y2', nd.y);
        line.setAttribute('stroke', clr);
        line.setAttribute('stroke-width', hot ? '2' : (0.6 + nd.mat * 1.2).toFixed(1));
        line.setAttribute('opacity', strength.toFixed(2));
        if (hot) line.style.animation = 'synapse-pulse 1.2s ease-in-out infinite';
        frag.appendChild(line);
    });

    var crossThresh = totalNodes > 30 ? 0.35 : 0.15;
    var crossMax = totalNodes > 30 ? 40 : 200;
    var crossCount = 0;
    nodes.forEach(function(a) {
        if (crossCount >= crossMax) return;
        nodes.forEach(function(b) {
            if (crossCount >= crossMax) return;
            if (a.name >= b.name || a.orb === b.orb) return;
            if (a.mat > crossThresh && b.mat > crossThresh) {
                var s = Math.min(a.mat, b.mat);
                var cl = document.createElementNS(ns, 'line');
                cl.setAttribute('x1', a.x); cl.setAttribute('y1', a.y);
                cl.setAttribute('x2', b.x); cl.setAttribute('y2', b.y);
                cl.setAttribute('stroke', lerpColor(maturityColor(a.mat,C), maturityColor(b.mat,C), 0.5));
                cl.setAttribute('stroke-width', '0.4');
                cl.setAttribute('opacity', (s * 0.12).toFixed(2));
                cl.setAttribute('stroke-dasharray', '2,6');
                frag.appendChild(cl);
                crossCount++;
            }
        });
    });

    nodes.forEach(function(nd) {
        var p = nd.p, hot = activeSet[p.name], evo = evoMap[p.name];
        var promoted = evo && evo.p;
        var clr = maturityColor(nd.mat, C);
        var fillAlpha = (0.06 + nd.mat * 0.12).toFixed(2);
        var pr = parseInt(clr.slice(1,3),16), pg = parseInt(clr.slice(3,5),16), pb = parseInt(clr.slice(5,7),16);
        var fillRgba = 'rgba('+pr+','+pg+','+pb+','+fillAlpha+')';

        var g = document.createElementNS(ns, 'g');
        if (hot) g.setAttribute('filter', 'url(#glow)');

        var hex = document.createElementNS(ns, 'polygon');
        hex.setAttribute('points', hexPoints(nd.x, nd.y, nodeR));
        hex.setAttribute('fill', fillRgba);
        hex.setAttribute('stroke', hot ? C.ac : clr);
        hex.setAttribute('stroke-width', hot ? '2.5' : (0.8 + nd.mat).toFixed(1));
        g.appendChild(hex);

        if (evo && !promoted) {
            var pct = Math.min(1, evo.v / threshold);
            if (pct > 0.01 && pct < 0.999) {
                var aR = nodeR + 4;
                var ea = -Math.PI/2 + pct * Math.PI * 2;
                var la = pct > 0.5 ? 1 : 0;
                var x1 = nd.x + aR * Math.cos(-Math.PI/2), y1 = nd.y + aR * Math.sin(-Math.PI/2);
                var x2 = nd.x + aR * Math.cos(ea), y2 = nd.y + aR * Math.sin(ea);
                var arc = document.createElementNS(ns, 'path');
                arc.setAttribute('d', 'M'+x1.toFixed(1)+','+y1.toFixed(1)+' A'+aR+','+aR+' 0 '+la+',1 '+x2.toFixed(1)+','+y2.toFixed(1));
                arc.setAttribute('fill', 'none'); arc.setAttribute('stroke', clr);
                arc.setAttribute('stroke-width', '2.5'); arc.setAttribute('stroke-linecap', 'round');
                arc.setAttribute('opacity', '0.6');
                g.appendChild(arc);
            }
        }

        if (promoted) {
            var star = document.createElementNS(ns, 'text');
            star.setAttribute('x', nd.x + nodeR * 0.7); star.setAttribute('y', nd.y - nodeR * 0.65);
            star.setAttribute('font-size', nodeR * 0.65); star.setAttribute('fill', C.warn);
            star.textContent = '\u2605';
            g.appendChild(star);
        }

        var nm = document.createElementNS(ns, 'text');
        nm.setAttribute('x', nd.x); nm.setAttribute('y', nd.y + (p.memory > 0 ? -2 : 1));
        nm.setAttribute('text-anchor', 'middle'); nm.setAttribute('dominant-baseline', 'central');
        nm.setAttribute('fill', C.tx); nm.setAttribute('font-weight', '700');
        var nameFs = totalNodes > 30 ? Math.max(7, nodeR * 0.38) : Math.max(8, nodeR * 0.42);
        nm.setAttribute('font-size', nameFs);
        var maxCh = totalNodes > 30 ? 7 : 9;
        nm.textContent = p.name.length > maxCh ? p.name.slice(0, maxCh-1)+'..' : p.name;
        g.appendChild(nm);

        if (p.memory > 0) {
            var mt = document.createElementNS(ns, 'text');
            mt.setAttribute('x', nd.x); mt.setAttribute('y', nd.y + nodeR * 0.45);
            mt.setAttribute('text-anchor', 'middle'); mt.setAttribute('fill', clr);
            mt.setAttribute('font-size', Math.max(7, nodeR * 0.32)); mt.setAttribute('font-weight', '600');
            mt.textContent = p.memory + '\u6761';
            g.appendChild(mt);
        }

        frag.appendChild(g);
    });

    var lg = document.createElementNS(ns, 'g');
    var ly = H - 12, lx = 12;
    [
        ['\u25c6 \u65b0\u751f', C.newborn],
        ['\u25c6 \u6210\u957f', C.growing],
        ['\u25c6 \u6210\u719f', C.mature],
        ['\u2015 \u7a81\u89e6', C.ac]
    ].forEach(function(item, i) {
        var t = document.createElementNS(ns, 'text');
        t.setAttribute('x', lx + i * 72); t.setAttribute('y', ly);
        t.setAttribute('fill', item[1]); t.setAttribute('font-size', '10');
        t.setAttribute('opacity', '0.55'); t.setAttribute('font-weight', '600');
        t.textContent = item[0];
        lg.appendChild(t);
    });
    frag.appendChild(lg);

    while (svg.firstChild) svg.removeChild(svg.firstChild);
    svg.appendChild(frag);
}

function hexPoints(cx, cy, r) {
    var pts = [];
    for (var i = 0; i < 6; i++) {
        var a = Math.PI / 6 + i * Math.PI / 3;
        pts.push((cx + r * Math.cos(a)).toFixed(1) + ',' + (cy + r * Math.sin(a)).toFixed(1));
    }
    return pts.join(' ');
}

function renderEvo(d) {
    var el = document.getElementById('view-evo');
    if (!el || !d.evo) return;
    var e = d.evo;
    var html = '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">';
    html += '<span class="chip">\u8bb0\u5f55 <b>'+e.total+'</b></span>';
    html += '<span class="chip">\u664b\u5347 <b>'+e.promoted+'</b></span>';
    html += '<span class="chip">L2\u89c4\u5219 <b>'+e.l2+'</b></span>';
    html += '<span class="chip">\u5019\u9009 <b>'+e.candidates+'</b></span>';
    html += '<span class="chip">\u664b\u5347\u9608\u503c <b>'+e.threshold+'</b></span>';
    html += '</div>';
    var recs = e.records || [];
    if (recs.length) {
        recs.forEach(function(r) {
            var pct = Math.min(100, (r.v / e.threshold) * 100);
            html += '<div class="evo-bar-row">';
            html += '<span class="evo-label">'+r.pouch+'</span>';
            html += '<span class="evo-track"><span class="evo-fill '+(r.p?'evo-fill-p':'evo-fill-n')+'" style="width:'+pct+'%"></span></span>';
            html += '<span class="evo-val">'+r.v+(r.p?' <span class="evo-star">\u2605</span>':'')+'</span>';
            html += '</div>';
        });
    } else {
        html += '<div style="opacity:0.3;padding:20px;text-align:center">\u6682\u65e0\u6f14\u5316\u8bb0\u5f55\uff0c\u5f00\u59cb\u4f7f\u7528\u7cfb\u7edf\u540e\u81ea\u52a8\u7d2f\u79ef</div>';
    }
    el.innerHTML = html;
}

function renderEvents(d) {
    var el = document.getElementById('view-events');
    if (!el) return;
    var evts = (d.events||[]).slice().reverse();
    var html = '';
    evts.forEach(function(e) {
        var cls = 'ev-line';
        if (e.indexOf('EXEC') >= 0) cls += ' ev-exec';
        else if (e.indexOf('ROUTE') >= 0) cls += ' ev-route';
        else if (e.indexOf('CACHE') >= 0) cls += ' ev-cache';
        else if (e.indexOf('ABSORB') >= 0) cls += ' ev-absorb';
        else if (e.indexOf('SELF_OPT') >= 0) cls += ' ev-self';
        else if (e.indexOf('EVOLVE') >= 0) cls += ' ev-evolve';
        else if (e.indexOf('AUTO_POUCH') >= 0) cls += ' ev-auto';
        html += '<div class="'+cls+'">'+e+'</div>';
    });
    el.innerHTML = html || '<div style="opacity:0.2;text-align:center;padding:20px">\u7b49\u5f85\u4e8b\u4ef6...</div>';
}

function renderStats(d) {
    var el = document.getElementById('view-stats');
    if (!el) return;
    var fb = d.fb || {};
    var html = '<div class="stat-grid">';
    html += statCell(d.memory||0, '\u6a21\u5f0f\u603b\u91cf');
    html += statCell(fb.absorbed||0, '\u5df2\u5438\u6536');
    html += statCell(fb.net||0, '\u51c0\u6b63\u53cd\u9988');
    html += statCell(fb.log||0, '\u53cd\u9988\u65e5\u5fd7');
    html += statCell(fb.misses||0, '\u5f85\u5b66\u4e60');
    html += statCell((d.pouches||[]).length, '\u5c3f\u888b\u6570');
    html += '</div>';
    if (d.cfg) {
        html += '<div style="margin-top:12px">';
        html += '<div style="font-size:11px;font-weight:700;opacity:0.3;margin-bottom:6px">\u8def\u7531\u914d\u7f6e</div>';
        html += '<div class="cfg-row"><span>\u57fa\u7ebf\u5206</span><b>'+d.cfg.baseline.toFixed(2)+'</b></div>';
        html += '<div class="cfg-row"><span>\u4f4e\u5206\u9608\u503c</span><b>'+d.cfg.low.toFixed(2)+'</b></div>';
        html += '<div class="cfg-row"><span>\u664b\u5347\u6700\u4f4e\u5206</span><b>'+d.cfg.promote.toFixed(3)+'</b></div>';
        html += '</div>';
    }
    el.innerHTML = html;
}

function renderDiag(d) {
    var el = document.getElementById('diag-body');
    if (!el) return;
    var fb = d.fb || {};
    var html = '<div style="font-size:11px;font-weight:700;opacity:0.3;margin-bottom:8px">\u53cd\u54fa\u72b6\u6001</div>';
    html += '<table style="width:100%;font-size:12px;border-collapse:collapse">';
    html += diagRow('\u5df2\u5438\u6536', fb.absorbed||0);
    html += diagRow('\u53cd\u9988\u65e5\u5fd7', fb.log||0);
    html += diagRow('\u5f85\u5b66\u4e60', fb.misses||0);
    html += diagRow('\u6a21\u5f0f\u603b\u91cf', d.memory||0);
    html += diagRow('\u51c0\u6b63\u53cd\u9988', fb.net||0);
    html += '</table>';
    html += '<div style="font-size:11px;font-weight:700;opacity:0.3;margin:12px 0 8px">\u7cfb\u7edf\u4fe1\u606f</div>';
    html += '<table style="width:100%;font-size:12px;border-collapse:collapse">';
    html += diagRow('\u7248\u672c', 'v'+(d.v||'?'));
    html += diagRow('CPU', (d.cpu||0).toFixed(1)+'%');
    html += diagRow('\u5185\u5b58', (d.mem||0)+' MB');
    html += diagRow('\u6e29\u5ea6', (d.temp||0).toFixed(0)+'\u00b0C');
    html += diagRow('\u5c3f\u888b', (d.pouches||[]).length);
    html += diagRow('\u539f\u5b50', d.atoms?d.atoms.total:0);
    html += '</table>';
    el.innerHTML = html;
}
function diagRow(label, val) {
    return '<tr style="border-bottom:1px solid var(--bd)"><td style="padding:4px 0;opacity:0.6">'+label+'</td><td style="padding:4px 0;text-align:right;font-weight:700;color:var(--ac)">'+val+'</td></tr>';
}

function statCell(val, label) {
    return '<div class="stat-cell"><div class="stat-val">'+val+'</div><div class="stat-lbl">'+label+'</div></div>';
}
function setText(id, v) { var e = document.getElementById(id); if (e) e.textContent = v; }

function setMode(m) {
    mode = m;
    document.getElementById('btn-cmd').className = 'mode-btn' + (m==='command'?' active':'');
    document.getElementById('btn-nat').className = 'mode-btn' + (m==='natural'?' active':'');
    document.getElementById('btn-lang').className = 'mode-btn' + (m==='language'?' active':'');
    var pr = document.getElementById('term-prompt');
    var inp = document.getElementById('term-input');
    if (m === 'command') {
        if (pr) pr.textContent = '$';
        if (inp) inp.placeholder = '\u8f93\u5165\u547d\u4ee4\uff0c\u56de\u8f66\u53d1\u9001';
    } else if (m === 'natural') {
        if (pr) pr.textContent = '\u00bb';
        if (inp) inp.placeholder = '\u8f93\u5165\u95ee\u9898\u6216\u5bf9\u8bdd...';
    } else {
        if (pr) pr.textContent = 'L>';
        if (inp) inp.placeholder = '\u76f4\u901a\u8bed\u8a00\u5c3f\u888b\u8c03\u8bd5...';
    }
}

var termInput = document.getElementById('term-input');
if (termInput) {
    termInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });
    termInput.addEventListener('keydown', function(e) {
        if (e.key !== 'Enter' && e.keyCode !== 13) return;
        if (e.shiftKey) return;
        e.preventDefault();
        var cmd = termInput.value.trim();
        if (!cmd) return;
        termInput.value = '';
        termInput.style.height = 'auto';
        handleSubmit(cmd);
    });
}

function handleSubmit(cmd) {
    var term = document.getElementById('term');
    if (!term) return;
    var prompts = {command:'$ ', natural:'\u00bb ', language:'L> '};
    appendLine(term, (prompts[mode]||'$ ') + cmd, 'font-weight:600');
    term.scrollTop = term.scrollHeight;
    var backend = getBackend();
    if (mode === 'language') {
        if (!backend) { appendLine(term, '\u9519\u8bef\uff1a\u9700\u8981\u914d\u7f6e\u540e\u7aef\u5730\u5740', 'color:var(--err)'); return; }
        fetch(backend+'/api/language_debug',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({input:cmd})}).then(function(r){return r.json()}).then(function(d){
            appendLine(term, d.response||'', 'opacity:0.7');
            appendLine(term, (d.is_fallback?'[\u672a\u547d\u4e2d]':'[\u547d\u4e2d]')+' \u6743\u91cd='+(d.last_match_weight!=null?d.last_match_weight.toFixed(2):'?'), 'font-size:10px;opacity:0.3');
            addFbRow(term, cmd);
            term.scrollTop = term.scrollHeight;
        }).catch(function(e){ appendLine(term, '\u9519\u8bef\uff1a'+e.message, 'color:var(--err)'); });
        return;
    }
    if (mode === 'natural' && backend) {
        fetch(backend+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message:cmd})}).then(function(r){return r.json()}).then(function(d){
            appendLine(term, d.response||d.reply||d.error||JSON.stringify(d), 'opacity:0.7');
            if (d.pouch) appendLine(term, '\u5c3f\u888b: '+d.pouch, 'font-size:10px;opacity:0.3');
            addFbRow(term, cmd);
            term.scrollTop = term.scrollHeight;
        }).catch(function(e){ appendLine(term, '\u9519\u8bef\uff1a'+e.message, 'color:var(--err)'); });
        return;
    }
    var payload = {command:cmd};
    if (mode === 'natural') payload.mode = 'natural';
    if (backend) payload.backend = backend;
    fetch(WORKER+'/execute',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)}).then(function(r){return r.json()}).then(function(d){
        var txt = d.error ? d.error+(d.hint?'\n'+d.hint:'') : d.reply||JSON.stringify(d,null,2);
        appendLine(term, txt, 'opacity:0.7');
        addFbRow(term, cmd);
        term.scrollTop = term.scrollHeight;
    }).catch(function(e){ appendLine(term, '\u9519\u8bef\uff1a'+e.message, 'color:var(--err)'); });
}

function appendLine(parent, text, style) {
    var d = document.createElement('div');
    if (style) d.style.cssText = style;
    d.textContent = text;
    parent.appendChild(d);
    while (parent.children.length > 300) parent.removeChild(parent.firstChild);
}

function addFbRow(term, inputSnap) {
    var row = document.createElement('div');
    row.className = 'fb-row';
    var backend = getBackend();
    function mk(label, sig, clr) {
        var b = document.createElement('button');
        b.className = 'fb-btn'; b.textContent = label;
        b.onclick = function() {
            var url = backend ? backend+'/api/feedback' : WORKER+'/feedback';
            fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({input:inputSnap,signal:sig})}).catch(function(){});
            b.style.color = clr; b.style.opacity = '0.7'; b.onclick = null;
        };
        return b;
    }
    row.appendChild(mk('\u25b2 \u8d5e', 1, 'var(--ok)'));
    row.appendChild(mk('\u25bc \u8e29', -1, 'var(--err)'));
    var cBtn = document.createElement('button');
    cBtn.className = 'fb-btn'; cBtn.textContent = '\u270e \u7ea0\u6b63';
    cBtn.onclick = function() {
        var c = window.prompt('\u8f93\u5165\u6b63\u786e\u7b54\u6848\uff1a');
        if (c && c.trim()) {
            var url = backend ? backend+'/api/feedback' : WORKER+'/feedback';
            fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({input:inputSnap,signal:-1,correction:c.trim()})}).catch(function(){});
            cBtn.textContent = '\u270e \u5df2\u7ea0\u6b63'; cBtn.style.color = 'var(--warn)'; cBtn.style.opacity = '0.7'; cBtn.onclick = null;
        }
    };
    row.appendChild(cBtn);
    term.appendChild(row);
}

(function initTerm() {
    var term = document.getElementById('term');
    if (term) appendLine(term, '\u7cfb\u7edf\u5c31\u7eea\u3002', 'opacity:0.3;font-style:italic');
})();

function toggleTheme() { document.body.classList.toggle('light'); }
function toggleSettings() {
    var p = document.getElementById('settings-overlay');
    if (!p) return;
    var vis = p.style.display === 'block';
    p.style.display = vis ? 'none' : 'block';
    if (!vis) {
        document.getElementById('s-worker').value = WORKER;
        document.getElementById('s-backend').value = localStorage.getItem('logos_backend')||'';
    }
}
function saveSettings() {
    var w = document.getElementById('s-worker').value.trim();
    var b = document.getElementById('s-backend').value.trim();
    if (w) localStorage.setItem('logos_worker', w);
    localStorage.setItem('logos_backend', b);
    location.reload();
}

window.addEventListener('resize', function(){ if (D) renderNeural(); });
setTimeout(function(){ if (D) renderNeural(); }, 500);
</script>
</body>
</html>